<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <!-- Use W3.CSS CDN so `w3-indigo` and other classes are available -->
        <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
        <!-- QR Code Scanner Library -->
        <script src="https://unpkg.com/html5-qrcode"></script>
        <title>QR reader</title>
        <style>
            /* small local tweaks to match screenshot proportions */
            .viewer-box {
                width: 300px;
                height: 300px;
                border: 2px solid #222;
                display: inline-block;
                background: white;
            }

            #qr-reader {
                width: 70%;
                height: 70%;
            }

            body {
                display: flex;
                flex-direction: column;
                min-height: 100vh;
            }
            .page-wrap { flex: 1; min-height: 80vh; }
            .page-footer { padding-top: 18px; padding-bottom: 18px; }

            /* Force webcam to be non-mirrored (same as student.html) */
            #qr-reader video,
            #qr-reader .html5-qrcode-video,
            .html5-qrcode-video {
                transform: scaleX(-1) !important;
                -webkit-transform: scaleX(-1) !important;
            }
        </style>
    </head>
    <body class="w3-white">
        <!-- Header: left title, right login -->
        <div class="w3-bar w3-indigo w3-text-white">
            <div class="w3-bar-item w3-large">Python(20420) 10:30 - 12:01 MW</div>
            <a href="/login" class="w3-bar-item w3-button w3-right w3-small w3-text-white">LOGIN</a>
        </div>

        <!-- Main content area -->
        <div class="w3-container page-wrap">
            <div class="w3-row">
                <div class="w3-col m3 l3">&nbsp;</div>
                <div class="w3-col s12 m6 l6 w3-center" style="margin-top:48px;">
                    <div class="viewer-box" id="qr-reader"></div>
                </div>
                <div class="w3-col m3 l3">&nbsp;</div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="w3-container w3-light-grey w3-border-top page-footer">
            <div class="w3-center w3-small">&copy; Jude Khalil Veloso, Rasheed Boriss Yap, 2025</div>
        </footer>

        <script>
            // Initialize QR Code Scanner
            const qr = new Html5Qrcode("qr-reader");
            let scanning = false;

            function fixMirror() {
                // If the camera is mirrored by the browser, flip it back manually
                const elements = document.querySelectorAll('#qr-reader video, #qr-reader canvas');
                elements.forEach(el => {
                    el.classList.remove('mirrored', 'mirror');
                    // Flip horizontally to counter browser mirroring
                    el.style.transform = 'scaleX(-1)';
                    el.style.webkitTransform = 'scaleX(-1)';
                });
            }

            // Run fixMirror more frequently
            const obs = new MutationObserver(() => {
                fixMirror();
                setTimeout(fixMirror, 100);
            });
            obs.observe(document.getElementById('qr-reader'), { childList: true, subtree: true, attributes: true, attributeFilter: ['style', 'class'] });

            function startDefault() {
                if (scanning) return;
                scanning = true;
                // Try rear camera first (never mirrored)
                qr.start(
                    { facingMode: { exact: "environment" } },
                    { fps: 10, qrbox: 250, disableFlip: true },
                    onScanSuccess,
                    onScanFailure
                ).then(() => {
                    fixMirror();
                    setTimeout(fixMirror, 200);
                    setTimeout(fixMirror, 500);
                })
                 .catch(async () => {
                    // Fallback to front camera
                    await qr.start(
                        { facingMode: "user" },
                        { fps: 10, qrbox: 250, disableFlip: true },
                        onScanSuccess,
                        onScanFailure
                    );
                    fixMirror();
                    setTimeout(fixMirror, 200);
                    setTimeout(fixMirror, 500);
                });
            }
            startDefault();

            function onScanSuccess(decodedText, decodedResult) {
                console.log(`QR Code detected: ${decodedText}`);
                // Redirect to check.html with QR code data
                window.location.href = `/check?qr_code=${encodeURIComponent(decodedText)}`;
            }

            function onScanFailure(error) {}
        </script>

    </body>
</html>